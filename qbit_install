#!/bin/bash

source src/qbit_user
source src/qbit_service
source src/qbit_rclone
source src/qbit_rss
source src/qbit_rules
source src/qbit_conf

# Define timezone
sudo timedatectl set-timezone America/Sao_Paulo

# Instala dependencias
sudo apt install unzip -y; apt install zip -y;
sudo add-apt-repository ppa:qbittorrent-team/qbittorrent-stable -y
sudo apt install qbittorrent-nox -y
sudo curl https://rclone.org/install.sh | sudo bash

# Download da config do rclone
if [ ${rcloneDownloadConfig} = "on" ]; then
  mkdir -p ${rcloneFilesDir}/config/
  wget $rcloneConfig -P ${rcloneFilesDir}/config/
fi

# Inicia script personalizado
qbit_onStart

# Configura e monta remotes do rclone
qbit_rclone

# Configura service do qBittorrent
qbit_service

# Cria pastas necessárias
mkdir -p ~/qBittorrent/downloads/
mkdir -p ~/qBittorrent/files/
mkdir -p ~/qBittorrent/files_incomplete/
mkdir -p ~/qBittorrent/config/
mkdir -p ~/qBittorrent/config/rss/

if [ ${autoTorrents} = "on" ]; then
  # Download dos arquivos .torrent
  pathUnzip=~/qBittorrent/files/
  rclone copy ${filesRemote}:torrents_latest.zip ${pathUnzip} --config ${rcloneFilesDir}/config/rclone.conf
  unzip ${pathUnzip}/torrents_latest.zip -d ${pathUnzip}
  rm ${pathUnzip}/torrents_latest.zip

  if [ ${crontabEnable} = "on" ]; then
    # Cria symlinks
    ln -s $moviesPath$cronMovies ~/qBittorrent/downloads/
    ln -s $tvPath$cronTv ~/qBittorrent/downloads/
    ln -s $epsPath$cronEps ~/qBittorrent/downloads/
  fi
fi

# Zipar e salvar os .torrents na nuvem.
if [ ${torrentsFileEnable} = "on" ]; then
  sudo echo "zip -9 -r ~/qBittorrent/files/torrents_latest.zip ~/qBittorrent/files/*.torrent"                                                                          > /usr/bin/uploadFiles
  sudo echo "rclone moveto ${filesRemote}:torrents_latest.zip ${filesRemote}:\$(date +\"%d-%m-%Y\").zip --config ${rcloneFilesDir}/config/rclone.conf"                 >> /usr/bin/uploadFiles
  sudo echo "sleep 60"                                                                                                                                                 >> /usr/bin/uploadFiles
  sudo echo "rclone move ~/qBittorrent/files/torrents_latest.zip ${filesRemote}: --checksum --drive-chunk-size=16M --config ${rcloneFilesDir}/config/rclone.conf"      >> /usr/bin/uploadFiles
  sudo chmod a+x /usr/bin/uploadFiles

  # Cria regra no crontab
  sudo crontab -l > mycron
  sudo echo "0 */2 * * * /usr/bin/uploadFiles  >/dev/null 2>&1"                                                                                                        >> mycron
  sudo crontab mycron
  sudo rm mycron
fi

# Adiciona conf do script
qbit_conf

# Download da WebUI
# if [ $webUI = "on" ]; then
#   git clone --single-branch --branch latest-release https://github.com/WDaan/VueTorrent.git /home/$USER/qBittorrent/config/webUI/VueTorrent/
# fi

# Se ativado, adiciona regras e RSS
qbit_rss
qbit_rules

# Inicia qBittorrent
if [ ${autoTorrents} = "on" ]; then
  qbittorrent-nox -d --profile=~/ --webui-port=${portWeb} --category=autoTorrents --skip-hash-check --save-path=~/qBittorrent/downloads/ ~/qBittorrent/files/*.torrent
else
  qbittorrent-nox -d --profile=~/ --webui-port=${portWeb}
fi

# Service qBittorrent
sudo systemctl enable qbittorrent-${portWeb}.service

# Inicia script personalizado
qbit_onEnd

# Cores
green=$(tput setaf 2)
blue=$(tput setaf 6)
white=$(tput setaf 7)
normal=$(tput sgr0)
format="%s${normal}\n"

if [ $rcloneDownloadConfig = "on" ]; then
  printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
  printf $format "${green}Instalação concluída."
  printf "\n"
  printf $format "${white}Acesse: ${blue}http://${ip}:${portWeb}/"
  printf $format "${white}Usuário: ${blue}admin"
  printf $format "${white}Senha: ${blue}adminadmin"
  printf "\n\n"
else
  printf "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"
  printf $format "${green}Instalação concluída."
  printf "\n"
  printf $format "${white}Acesse: ${blue}http://${ip}:${portWeb}/"
  printf $format "${white}Usuário: ${blue}admin"
  printf $format "${white}Senha: ${blue}adminadmin"
  printf "\n"
  printf $format "${white}Você não adicionou sua config do rclone no script,"
  printf $format "${white}portanto devera fazer isso agora."
  printf "\n"
  printf $format "${white}Execute o comando: ${blue}rclone config --config /home/$USER/rclone/config/rclone.conf"
  printf $format "${white}E conforme definido no script, você precisa criar os remotes com os seguintes nomes;"
  printf "\n"
  printf $format "  ${blue}$moviesRemote ${white}para os filmes."
  printf $format "  ${blue}$tvRemote ${white}para as séries"
  printf $format "  ${blue}$epsRemote ${white}para os episódios avulsos."
  if [ $torrentsFileEnable = "on" ]; then
    printf $format "  ${blue}$filesRemote ${white}para os arquivos .torrent."
    printf "\n"
  else
    printf "\n"
  fi
  printf $format "${white}Após ter configurado execute o comando;"
  printf $format "${blue}sudo systemctl start {${tvRemote}.service,${moviesRemote}.service,${epsRemote}.service}"
  printf "\n\n"
fi